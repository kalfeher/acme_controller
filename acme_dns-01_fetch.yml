---
  # The conditional statement below will use a random recursive server to check that the challenge record is visible to external systems.
  - name: Fetch cert if challenge published
    acme_certificate:
      account_key_src: "{{ ac_priv_key_path }}"
      modify_account: no
      src: "{{ ac_working_dir }}/{{domain.name}}/{{domain.name}}.csr"
      cert: "{{ ac_working_dir }}/{{domain.name}}/certs/{{domain.name}}.crt"
      chain: "{{ ac_working_dir }}/{{domain.name}}/certs/chain.crt"
      challenge: dns-01
      acme_directory: "{{ac_acme_api_uri}}"
      remaining_days: "{{renew_days_before_expiry}}"
      acme_version: 2
      data: "{{challenge}}"
    when: (True if item.value[0] == lookup('dig', item.key +'.', 'qtype=TXT', 'name_server='+ recursive_DNS|random) else False)
    loop: "{{challenge.challenge_data_dns | dict2items }}"
